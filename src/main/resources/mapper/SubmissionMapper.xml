<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.no99.edunexusassignment_and_assessment.mapper.SubmissionMapper">

    <!-- 结果映射 -->
    <resultMap id="SubmissionResultMap" type="com.no99.edunexusassignment_and_assessment.entity.Submission">
        <id column="id" property="id"/>
        <result column="assignment_id" property="assignmentId"/>
        <result column="user_id" property="userId"/>
        <result column="attempt_number" property="attemptNumber"/>
        <result column="content" property="content"/>
        <result column="submission_date" property="submissionDate"/>
        <result column="grade" property="grade"/>
        <result column="graded_at" property="gradedAt"/>
        <result column="graded_by" property="gradedBy"/>
        <result column="feedback" property="feedback"/>
        <result column="status" property="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
    </resultMap>

    <!-- 插入提交记录 -->
    <insert id="insert" parameterType="com.no99.edunexusassignment_and_assessment.entity.Submission" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO submissions (
            assignment_id, user_id, attempt_number, content,
            submission_date, grade, graded_at, graded_by,
            feedback, status
        ) VALUES (
            #{assignmentId}, #{userId}, #{attemptNumber}, #{content},
            #{submissionDate}, #{grade}, #{gradedAt}, #{gradedBy},
            #{feedback}, #{status}
        )
    </insert>

    <!-- 更新提交记录 -->
    <update id="update" parameterType="com.no99.edunexusassignment_and_assessment.entity.Submission">
        UPDATE submissions
        SET assignment_id = #{assignmentId},
            user_id = #{userId},
            attempt_number = #{attemptNumber},
            content = #{content},
            submission_date = #{submissionDate},
            grade = #{grade},
            graded_at = #{gradedAt},
            graded_by = #{gradedBy},
            feedback = #{feedback},
            status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 动态查询条件 -->
    <sql id="whereClause">
        <where>
            <if test="assignmentId != null">
                AND assignment_id = #{assignmentId}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="gradedBy != null">
                AND graded_by = #{gradedBy}
            </if>
        </where>
    </sql>

    <!-- 分页查询提交记录 -->
    <select id="selectByConditions" resultMap="SubmissionResultMap">
        SELECT * FROM submissions
        <include refid="whereClause"/>
        ORDER BY submission_date DESC
        <if test="limit != null and offset != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 查询提交记录统计 -->
    <select id="selectSubmissionStats" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_count,
            COUNT(CASE WHEN status = 'graded' THEN 1 END) as graded_count,
            COUNT(CASE WHEN status = 'submitted' THEN 1 END) as ungraded_count,
            COUNT(CASE WHEN status = 'late' THEN 1 END) as late_count,
            AVG(CASE WHEN grade IS NOT NULL THEN grade END) as avg_grade
        FROM submissions
        WHERE assignment_id = #{assignmentId}
    </select>

</mapper>
